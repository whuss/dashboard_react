{% extends 'layout.html' %}

{% block head %}
{{ js_resources|indent(4)|safe }}
{{ css_resources|indent(4)|safe }}
{% endblock %}

{% block page_title %}
<h1>Scene Analytics</h1>
{% endblock %}

{% block body %}
<div id="content">
  <table id="data-table" class="table">
    <thead class="thead-dark">
    <tr>
        <th>Device ID</th>
        <th>Scene durations</th>
    </tr>
    </thead>
  {% for data in data_list %}
  <tr>
    <th scope="row">{{data.device}}</th>
    <td><div align="center"><div class="bokeh-plot" {{data.plot_parameters|safe}}>{{data.plot_parameters}}</div></div></td>
  </tr>
  {% endfor %}
  </table>
</div>
{% endblock %}

{% block script %}
{% include 'includes/_data_table.html' %}
<script>
    function getDataAttributes(element) {
        //var data = [].filter.call(element.attributes, at => /^data-/.test(at.name));
        var data = {};
        [].forEach.call(element.attributes, function(attr) {
            if (/^data-/.test(attr.name)) {
                var camelCaseName = attr.name.substr(5).replace(/-(.)/g, function ($0, $1) {
                    return $1.toUpperCase();
                });
                data[camelCaseName] = attr.value;
            }
        });

        return data;
    }

    $(document).ready( function () {
        $('.error-table').DataTable({
            "paging": true,
            "info": false,
            "order": [[ 0, "desc" ]],
            stateSave: false,
        });
    } );

    $(document).ready( function()
    {
        const plots = document.querySelectorAll(".bokeh-plot");
        for (const plot of plots)
        {
            console.log('plot: ', plot);

            var data = getDataAttributes(plot)
            console.log(data);

            $.ajax({{ url_for('_get_plot')|tojson }},
            {
                data: JSON.stringify(data),
                contentType: 'application/json',
                type: 'POST'
            }
            ).done(drawPlot);
        }

        function drawPlot(data)
        {
            console.log('drawPlot: ', data.device, data.plotname);
            console.log(`div[data-device='${data.device}']`);
            //plot_element = document.querySelector(`div[data-device='${data.device}']`);
            //console.log('drawPlot: ', plot_element);
            //plot_element.html(data.html_plot);
            $(`div[data-device='${data.device}'][data-plotname='${data.plotname}']`).html(data.html_plot);
        }
    });
</script>
{% endblock script %}